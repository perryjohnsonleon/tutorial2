<html lang="zh-Hant-TW">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta http-equiv="content-type" content="text/html;charset=utf-8" />	
        <title>個股大盤分時走勢圖</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
	<style>
	  body {
		background: #000;   /* 黑色背景 */
		color: #fff;
	  }
	  canvas {
		max-width: 800px;
		margin: 20px auto;
		display: block;
	  }
	</style>
  </head>
 <body>
 <div style="display:flex;">
	<div><canvas id="realtimeChart" width="750" height="400"></canvas></div>
	<div id="collapseBtn2" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='collapseElement()' /></div>
 </div>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Annotation Plugin -->
<script>
//	const stockId_list=['2330','1102','1101','2356','2454','1402','2324','8150','2317','2002','2027','2303','2308','2887','2353','2347','2449','5410','3706','1301','2371','1504','0050','0056'] ;		
	const ctx = document.getElementById('realtimeChart').getContext('2d');
	// 初始數據
	let labels = [] , dataPoints1 = [] , dataPoints2 = [] , intervalIds = [] ;
	async function getData1() {
		  const response = await fetch("https://ws.api.cnyes.com/ws/api/v1/charting/history?resolution=1&symbol=TWS:1102:STOCK&quote=1"); 
		  if  (!response.ok) {
			  throw new Error(`HTTP error!!!! status: ${response.status}`);
			}
		  else {
			  const result = await response.json();
			  return result; // ← 正確把值傳出去 
		  }
	 }
	async function getData2() {
		  const response = await fetch("https://ws.api.cnyes.com/ws/api/v1/charting/history?symbol=TWS:TSE01:INDEX&resolution=D&quote=1&from=NaN&to=NaN"); 
		  if  (!response.ok) {
			  throw new Error(`HTTP error!!!! status: ${response.status}`);
			}
		  else {
			  const result = await response.json();
			  return result; // ← 正確把值傳出去 
		  }
	 }

	function collapseElement() {
		while(intervalIds.length){
		  clearInterval(intervalIds.pop());
		}
		// running= true ;
		//   clearInterval(repId);
		//   mask_item1.style.display="none" ;
    }
	
	async function main() {
		  let mymatrix,wi_o,wi_h,wi_c,wi_cc,wi_t,wi_tt,midline_txt1,midline_txt2,title_txt,item_price1,item_price2,item_name1,item_name2,mid_price1=0,mid_price2=0,min_price=0,max_price=0,incdecPrice1,incdecPrice2,timeLabel,labels=[],dataPoints1=[],dataPoints2=[],title1="圖例1",title2="圖例2",point_no=0;
		  const post1 = await getData1();
		  const post2 = await getData2();  		  
		  if (post1) {
			//	console.log("資料回來了:",post1);
				wi_o=post1.data.o;
				wi_h=post1.data.h;
				wi_c=post1.data.c;
			//	item_price1=wi_c ;
			//	item_price=wi_c[0];
			    const now = new Date();
			    timeLabel = now.toLocaleTimeString('zh-TW', { hour12: false, timeStyle: 'medium' });
				const quote_obj = post1.data.quote ;
				for ( var n in quote_obj) {
				   if ( n == "200009" )  item_name1=quote_obj[n] ;
				   if ( n == "11" ) incdecPrice1=quote_obj[n] ;
				   if ( n == "6" ) item_price1=quote_obj[n] ;
				}
				mid_price1=wi_c-incdecPrice1;
				midline_txt1= '平盤 y1=' + mid_price1.toString() ; 			
			}
		  if (post2) {
			//	console.log("資料回來了:",post2);
				wi_o=post2.data.o;
				wi_h=post2.data.h;
				wi_c=post2.data.c;
				item_price2=wi_c[0];
				const quote_obj = post2.data.quote ;
				for ( var n in quote_obj) {
				   if ( n == "200009" )  item_name2=quote_obj[n] ;
				   if ( n == "11" ) incdecPrice2= quote_obj[n] ;
				}
				mid_price2=wi_c-incdecPrice2;
				midline_txt2= '平盤 y2=' + mid_price2.toString() ; 				
			}		
		const chart = new Chart(ctx, {
		  type: 'line',
		  data: {
			labels: labels,
			datasets: [
			  {
				label: item_name1,
				data: dataPoints1,
				borderColor: 'red',
				yAxisID: 'y',     // 使用左側 Y 軸
			  },
			  {
				label: item_name2,
				data: dataPoints2,
				borderColor: 'blue',
				yAxisID: 'y1',    // 使用右側 Y 軸
			  }
			]
		  },

		  options: {
			responsive: true,
			interaction: {
			  mode: 'index',
			  intersect: false
			},
			scales: {
			  y: {
				type: 'linear',
				position: 'left',   // 左側 Y 軸
				value:mid_price1,
				title: {
				  display: true,
				  text: item_name1
				},
				label: {
				  display: true,
				  content: midline_txt1,			// '中線 y=38'
				  color: '#ff4444',
				  backgroundColor: '#000',
				  position: 'end'
				}				
			  },
			  y1: {
				type: 'linear',
				position: 'right',  // 右側 Y 軸
				value:mid_price2,
				grid: {
				  drawOnChartArea: false // 避免左右軸交叉網格重疊
				},
				title: {
				  display: true,
				  text: item_name2
				},
				label: {
				  display: true,
				  content: midline_txt2,			// '中線 y=38'
				  color: '#ff4444',
				  backgroundColor: '#000',
				  position: 'end'
				}		
			  }
			}
		  }
		});
		for (i=0;i<5;i++){		
			labels.push(timeLabel);			
			dataPoints1.push(item_price1);
			dataPoints2.push(item_price2);
		 }			 
		 chart.update();	
		  let running=false , count=0;
		  id=setInterval(async() => {
				// let mymatrix, wi_c , wi_t , wi_tt, midline_txt , mid_price=0 ,labels , dataPoints , title="" , point_no=0 ;
				if (running) return;
				  running=true;
				  const post1 = await getData1();
				  const post2 = await getData2();  		  
				  if (post1) {
						wi_o=post1.data.o;
						wi_h=post1.data.h;
						wi_c=post1.data.c;
						const now = new Date();
						timeLabel = now.toLocaleTimeString('zh-TW', { hour12: false, timeStyle: 'medium' });
						const quote_obj = post1.data.quote ;
						for ( var n in quote_obj) {
						   if ( n == "200009" )  item_name1=quote_obj[n] ;
						   if ( n == "11" ) incdecPrice1=quote_obj[n] ;
						   if ( n == "6" ) item_price1=quote_obj[n] ;
						}
						mid_price1=wi_c-incdecPrice1;
						midline_txt1= '平盤 y1=' + mid_price1.toString() ; 			
					}
				  if (post2) {
						wi_o=post2.data.o;
						wi_h=post2.data.h;
						wi_c=post2.data.c;
						item_price2=wi_c[0];
						const quote_obj = post2.data.quote ;
						for ( var n in quote_obj) {
						   if ( n == "200009" )  item_name2=quote_obj[n] ;
						   if ( n == "11" ) incdecPrice2= quote_obj[n] ;
						}
						mid_price2=item_price2-incdecPrice2;
						midline_txt2= '平盤 y2=' + mid_price2.toString() ; 				
					}
				 labels.push(timeLabel);
				 dataPoints1.push(item_price1);
				 dataPoints2.push(item_price2);	
				 chart.update();				
				 count++ ;
				 running=false ;
			},3000);
		 intervalIds.push(id); 
		  // doNextTask(data);
	}
	
	main();
</script>

  </body>
</html>