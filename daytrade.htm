<html lang="zh-Hant-TW">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta http-equiv="content-type" content="text/html;charset=utf-8" />	
        <title>當沖股分時走勢圖</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
	<style>
	  body {
		background: #000;   /* 黑色背景 */
		color: #fff;
	  }
	  canvas {
		max-width: 800px;
		margin: 20px auto;
		display: block;
	  }
	</style>
  </head>
 <body>
 <div style="display:flex;">
	<div><canvas id="realtimeChart" width="750" height="400"></canvas></div>
	<div style="display:block;">
		<div id="collapseBtn2" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='collapseElement()' /></div>
		<div id="sno2" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='showChart(1)' /></div>
		<div id="sno3" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='showChart(2)' /></div>
		<div id="sno4" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='showChart(3)' /></div>
		<div id="sno5" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='showChart(4)' /></div>
		<div id="sno6" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='showChart(5)' /></div>
		<div id="sno7" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='showChart(6)' /></div>
		<div id="sno8" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='showChart(7)' /></div>
		<div id="sno9" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='showChart(8)' /></div>
		<div id="sno1" style="justify-content:center;"><img src='collapse.png' style='cursor:pointer;' onclick='showChart(9)' /></div>		
	</div>
 </div>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Annotation Plugin -->
<script src="js/chartjs-plugin-annotation.js"></script>	
<script>
	const stockId_list=['1102','2330','2308','2303','6770','2353','2356','1301','1504','2371','0050','0052'] ;
    const intervalIds=[];	
	// 初始數據
	async function getData(stockId) {
	    console.log(888,stockId); 
		let fetchUrl_str="" ;
		let fetchUrl_str1="https://ws.api.cnyes.com/ws/api/v1/charting/history?resolution=1&symbol=TWS:" , fetchUrl_str2=":STOCK&quote=1"   ;
		if (stockId == 9999 ) 
			fetchUrl_str="https://ws.api.cnyes.com/ws/api/v1/charting/history?symbol=TWS:TSE01:INDEX&resolution=D&quote=1&from=NaN&to=NaN"
		else
			fetchUrl_str=fetchUrl_str1 + stockId_list[stockId] + fetchUrl_str2 ;
		// fetchUrl_str="https://ws.api.cnyes.com/ws/api/v1/charting/history?resolution=1&symbol=TWS:1102:STOCK&quote=1" ;
		const response = await fetch(fetchUrl_str); 
		if  (!response.ok) {
			  throw new Error(`HTTP error!!!! status: ${response.status}`);
			}
		  else {
			  const result = await response.json();
			  return result; // ← 正確把值傳出去 
		}
	 }

	function collapseElement() {
		while(intervalIds.length){
		  clearInterval(intervalIds.pop());
		}
		// running= true ;
		//   clearInterval(repId);
		//   mask_item1.style.display="none" ;
    }
	
	async function showChart(stockId) {
		  while(intervalIds.length) {
			  clearInterval(intervalIds.pop());
		  }
		  let mymatrix,wi_c,wi_cc,wi_t,wi_tt,midline_txt,item_price,item_name1,dataPoints=[],labels=[],mid_price=0,min_price=0,max_price=0,title="",point_no=0;
		  const oldChart=document.getElementById("realtimeChart");
		  if (oldChart) oldChart.outerHTML = "<canvas id='realtimeChart' width='750' height='400' style='display:block;'></canvas>" ;
	      const ctx = document.getElementById('realtimeChart').getContext('2d');			  
		  const post = await getData(stockId);  // ← 正確接收
		  if (post) {
			//	const wi_tmp=post.data.c ;
				wi_c=post.data.c ;
				wi_d=post.data.d ;
				wi_t=post.data.t ;
				wi_cc=[...wi_c].reverse() ;
				wi_tt=[...wi_t].reverse() ;
				dataPoints=[...wi_cc] ;
				for (i=0;i< wi_tt.length ;i++) {
					let date = new Date(wi_tt[i] * 1000);
					let time = date.toLocaleTimeString('zh-CN', {hour12: false,});
					wi_tt[i]=time;
				}
				labels=[...wi_tt];
				const quote_obj = post.data.quote ;
				for ( var n in quote_obj) {
				   if ( n == "6" ) item_price = quote_obj[n] ;
				   if ( n == "11" ) incdecPrice= quote_obj[n] ;
				   if ( n == "200009" ) item_name1=quote_obj[n] ;
				}
				mid_price=item_price-incdecPrice;
				midline_txt= item_name1 + '：中線 y=' + mid_price.toString() + '【' + wi_tt[wi_tt.length-1] + '】' ;  
			}
			const chart = new Chart(ctx, {
				  type: 'line',
				  data: {
					labels: labels,
					datasets: [
					  {
						label: title,
						data: dataPoints,
						borderColor: '#00ff88',   // 螢光綠線
						borderWidth: 2,
						tension: 0.3,
						fill: false,
						pointRadius: 0,           // 隱藏點
						pointHoverRadius: 0
					  }
					]
				  },
				  options: {
					responsive: true,
					animation: false,             // 關閉動畫，加速更新
					plugins: {
					  legend: { display: false },
					  tooltip: {
						mode: 'index',
						intersect: false,
						backgroundColor: '#111',
						titleColor: '#00ff88',
						bodyColor: '#fff'
					  },
					  annotation: {
						annotations: {
						  midline: {
							type: 'line',
							yMin: mid_price,
							yMax: mid_price,
							borderColor: '#ff4444',
							borderWidth: 1.5,
							borderDash: [6, 6],
							label: {
							  display: true,
							  content: midline_txt,			// '中線 y=38'
							  color: '#ff4444',
							  backgroundColor: '#000',
							  position: 'end'
							}
						  }
						}
					  }
					},
					scales: {
					  x: {
						grid: { display: false },
						ticks: { color: '#aaa' }
					  },
					  y: {
						grid: { color: '#333' },
						ticks: { color: '#aaa' }
					  }
					}
				  }
				});	
			chart.update();	
		 // console.log("資料回來了:", data);
		  // 接續執行任務
		  let running=false , count=0;
		  id=setInterval(async() => {
				// let mymatrix, wi_c , wi_t , wi_tt, midline_txt , mid_price=0 ,labels , dataPoints , title="" , point_no=0 ;
				if (running) return;
				running=true;
				const post =await getData(stockId) ;
				if (post) {
					//console.log("資料回來了:",post);
					wi_c=post.data.c ;
					wi_d=post.data.d ;
					wi_t=post.data.t ;
					wi_cc=[...wi_c].reverse() ;
					wi_tt=[...wi_t].reverse() ;
					dataPoints=[...wi_cc] ;
					for (i=0;i< wi_tt.length ;i++) {
						let date = new Date(wi_tt[i] * 1000);
						let time = date.toLocaleTimeString('zh-CN', {hour12: false,});
						wi_tt[i]=time;
					}
					labels=[...wi_tt];
					const quote_obj = post.data.quote ;
					for ( var n in quote_obj) {
					   if ( n == "6" ) mid_price = quote_obj[n] ;
					   if ( n == "11" ) incdecPrice= quote_obj[n] ;
					}
					mid_price=item_price-incdecPrice;					
					// midline_txt= '中線 y=' + mid_price.toString() + '【' + wi_tt[wi_tt.length-1] + '】' ;  
				}
				chart.update();	
				count++ ;
				running=false ;
			},3000);
		 intervalIds.push(id); 
		  // doNextTask(data);
	}	
	showChart(0);
</script>

  </body>
</html>